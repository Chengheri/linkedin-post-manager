<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Post Analyser</title>
    <!-- Load configuration and API scripts with cache busting -->
    <script src="config.js?v=1.1"></script>
    <script src="auth.js?v=1.1"></script>
    <script src="api.js?v=1.1"></script>
    <style>
        :root {
            --primary: #0077B5;
            --primary-light: #e1f0fa;
            --secondary: #57A8D7;
            --text: #283e4a;
            --text-light: #666;
            --bg: #fff;
            --bg-light: #f5f5f5;
            --border: #ddd;
            --success: #0a8f63;
            --danger: #e65252;
            --warning: #f5b82e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            color: var(--primary);
            font-weight: 600;
            font-size: 24px;
        }

        .logo svg {
            margin-right: 10px;
            width: 30px;
            height: 30px;
        }

        .app-nav {
            display: flex;
        }

        .nav-item {
            background: transparent;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-left: 25px;
            padding: 8px 0;
            position: relative;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary);
        }

        main {
            margin: 30px 0;
        }

        .card {
            background-color: var(--bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--primary-light);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .card-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 16px;
            color: var(--text);
            background: var(--bg);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 119, 181, 0.2);
        }

        .btn {
            background-color: var(--primary);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            padding: 12px 20px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #005e91;
        }

        .btn-secondary {
            background-color: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background-color: var(--bg-light);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #c03e3e;
        }

        .btn-sm {
            font-size: 14px;
            padding: 6px 12px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .post-table {
            width: 100%;
            border-collapse: collapse;
        }

        .post-table th {
            background-color: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
            padding: 12px 15px;
            text-align: left;
        }

        .post-table td {
            border-top: 1px solid var(--border);
            padding: 12px 15px;
        }

        .post-table tr:hover {
            background-color: var(--bg-light);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-published {
            background-color: #e6f7f1;
            color: var(--success);
        }

        .status-scheduled {
            background-color: #fff8e6;
            color: var(--warning);
        }

        .status-draft {
            background-color: #f0f0f0;
            color: var(--text-light);
        }

        .post-actions {
            display: flex;
            gap: 8px;
        }

        .post-actions button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .no-posts {
            text-align: center;
            padding: 50px 0;
            color: var(--text-light);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            color: var(--text-light);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--text);
            color: white;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--text) transparent transparent transparent;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .post-table {
                font-size: 14px;
            }

            .post-table th:nth-child(3),
            .post-table td:nth-child(3) {
                display: none;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .card-header .btn {
                margin-top: 10px;
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .app-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--bg);
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                display: flex;
                justify-content: space-around;
                padding: 10px 0;
                margin: 0;
            }

            .nav-item {
                margin: 0;
                font-size: 14px;
                text-align: center;
            }

            .nav-item.active:after {
                bottom: -10px;
            }

            main {
                margin-bottom: 70px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5C3.895 3 3 3.895 3 5V19C3 20.105 3.895 21 5 21H19C20.105 21 21 20.105 21 19V5C21 3.895 20.105 3 19 3ZM9 17H6.477V10H9V17ZM7.694 8.717C6.923 8.717 6.408 8.203 6.408 7.517C6.408 6.831 6.922 6.317 7.779 6.317C8.55 6.317 9.065 6.831 9.065 7.517C9.065 8.203 8.551 8.717 7.694 8.717ZM18 17H15.558V13.337C15.558 12.286 15.001 11.851 14.261 11.851C13.676 11.851 13.351 12.357 13.234 12.76C13.18 12.898 13.141 13.15 13.141 13.371V17H10.688V10H13.141V11.009C13.371 10.494 14.14 9.767 15.576 9.767C17.284 9.767 18.001 10.81 18.001 12.951L18 17Z"/>
                </svg>
                LinkedIn Post Analyser
            </div>
            <nav class="app-nav">
                <button class="nav-item active" data-section="dashboard">Dashboard</button>
                <button class="nav-item" data-section="posts">My Posts</button>
                <button class="nav-item" data-section="scheduled">Scheduled</button>
                <button class="nav-item" data-section="create">Create Post</button>
                <!-- New account button -->
                <button class="nav-item account-btn" data-section="account">
                    <span id="account-status-icon">🔴</span> Account
                </button>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <h2>Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-posts">0</div>
                        <div class="stat-label">Total Posts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="published-posts">0</div>
                        <div class="stat-label">Published</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="scheduled-posts">0</div>
                        <div class="stat-label">Scheduled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-engagement">0</div>
                        <div class="stat-label">Avg. Engagement</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Recent Activity</div>
                    </div>
                    <div class="card-body">
                        <table class="post-table" id="recent-posts-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Date</th>
                                    <th>Engagement</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recent-posts-body">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                        <div id="no-recent-posts" class="no-posts">
                            <p>No recent posts available. Start by creating a new post!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Posts Section -->
            <section id="posts" class="section">
                <h2>My Posts</h2>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">All Posts</div>
                    </div>
                    <div class="card-body">
                        <table class="post-table" id="all-posts-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Date</th>
                                    <th>Engagement</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-posts-body">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                        <div id="no-posts" class="no-posts">
                            <p>No posts available. Start by creating a new post!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Scheduled Section -->
            <section id="scheduled" class="section">
                <h2>Scheduled Posts</h2>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Upcoming Posts</div>
                    </div>
                    <div class="card-body">
                        <table class="post-table" id="scheduled-posts-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Scheduled Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="scheduled-posts-body">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                        <div id="no-scheduled-posts" class="no-posts">
                            <p>No scheduled posts. Plan your content in advance!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Create Post Section -->
            <section id="create" class="section">
                <h2>Create Post</h2>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">New Post</div>
                    </div>
                    <div class="card-body">
                        <form id="post-form">
                            <div class="form-group">
                                <label for="post-title">Post Title
                                    <span class="tooltip">?
                                        <span class="tooltip-text">A descriptive title to help you identify this post later</span>
                                    </span>
                                </label>
                                <input type="text" id="post-title" required placeholder="Enter a title for your post">
                            </div>

                            <div class="form-group">
                                <label for="post-content">Post Content
                                    <span class="tooltip">?
                                        <span class="tooltip-text">The main content of your LinkedIn post</span>
                                    </span>
                                </label>
                                <textarea id="post-content" required placeholder="Write your post content here..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="post-status">Post Status
                                    <span class="tooltip">?
                                        <span class="tooltip-text">Choose whether to publish now, schedule for later, or save as draft</span>
                                    </span>
                                </label>
                                <select id="post-status" required>
                                    <option value="published">Published</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="draft">Draft</option>
                                </select>
                            </div>

                            <div class="form-group" id="scheduled-date-group" style="display: none;">
                                <label for="scheduled-date">Schedule Date
                                    <span class="tooltip">?
                                        <span class="tooltip-text">When should this post be published?</span>
                                    </span>
                                </label>
                                <input type="datetime-local" id="scheduled-date">
                            </div>

                            <div class="form-group">
                                <label for="post-engagement">Engagement Metrics (optional)
                                    <span class="tooltip">?
                                        <span class="tooltip-text">Track the performance of published posts</span>
                                    </span>
                                </label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="likes" placeholder="Likes" min="0">
                                    <input type="number" id="comments" placeholder="Comments" min="0">
                                    <input type="number" id="shares" placeholder="Shares" min="0">
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn">Save Post</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Edit Post Section (Initially Hidden) -->
            <section id="edit" class="section">
                <h2>Edit Post</h2>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Edit Post</div>
                    </div>
                    <div class="card-body">
                        <form id="edit-form">
                            <input type="hidden" id="edit-post-id">

                            <div class="form-group">
                                <label for="edit-post-title">Post Title</label>
                                <input type="text" id="edit-post-title" required>
                            </div>

                            <div class="form-group">
                                <label for="edit-post-content">Post Content</label>
                                <textarea id="edit-post-content" required></textarea>
                            </div>

                            <div class="form-group">
                                <label for="edit-post-status">Post Status</label>
                                <select id="edit-post-status" required>
                                    <option value="published">Published</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="draft">Draft</option>
                                </select>
                            </div>

                            <div class="form-group" id="edit-scheduled-date-group" style="display: none;">
                                <label for="edit-scheduled-date">Schedule Date</label>
                                <input type="datetime-local" id="edit-scheduled-date">
                            </div>

                            <div class="form-group">
                                <label for="edit-post-engagement">Engagement Metrics</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="edit-likes" placeholder="Likes" min="0">
                                    <input type="number" id="edit-comments" placeholder="Comments" min="0">
                                    <input type="number" id="edit-shares" placeholder="Shares" min="0">
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" id="cancel-edit" class="btn btn-secondary">Cancel</button>
                                <button type="submit" class="btn">Update Post</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Account Section (New) -->
            <section id="account" class="section">
                <h2>LinkedIn Account</h2>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Account Connection</div>
                    </div>
                    <div class="card-body">
                        <div id="account-disconnected" style="display: none;">
                            <p>Connect your LinkedIn account to manage your posts directly from this app.</p>
                            <p>Once connected, you'll be able to:</p>
                            <ul style="margin-left: 20px; margin-bottom: 20px;">
                                <li>Import your LinkedIn posts</li>
                                <li>Schedule new posts</li>
                                <li>Monitor engagement metrics</li>
                                <li>Manage all your content in one place</li>
                            </ul>
                            <button id="connect-linkedin" class="btn">Connect LinkedIn Account</button>

                            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                                <h3>Use Access Token</h3>
                                <p>If you have a LinkedIn access token, you can enter it directly:</p>
                                <div style="display: flex; margin-top: 10px;">
                                    <input type="text" id="manual-token" placeholder="Paste your access token here" style="flex: 1;">
                                    <button id="save-token" class="btn" style="margin-left: 10px;">Save Token</button>
                                </div>
                            </div>
                        </div>

                        <div id="account-connected" style="display: none;">
                            <div class="profile-info" style="display: flex; align-items: center; margin-bottom: 20px;">
                                <div id="profile-picture" style="width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary-light); margin-right: 15px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; font-size: 24px;">
                                    <!-- Will be filled with profile image or initials -->
                                </div>
                                <div>
                                    <h3 id="profile-name" style="margin: 0 0 5px 0;">Connected</h3>
                                    <p id="connection-status" style="margin: 0; color: var(--success);">
                                        <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: var(--success); margin-right: 5px;"></span>
                                        Account connected
                                    </p>
                                </div>
                            </div>

                            <div class="account-actions">
                                <button id="sync-linkedin" class="btn">Sync Posts from LinkedIn</button>
                                <button id="disconnect-linkedin" class="btn btn-secondary" style="margin-left: 10px;">Disconnect Account</button>
                            </div>

                            <div id="sync-status" style="margin-top: 20px; display: none;">
                                <p>Syncing your posts... <span id="sync-progress">0%</span></p>
                                <div style="height: 5px; width: 100%; background-color: var(--bg-light); border-radius: 3px; overflow: hidden;">
                                    <div id="sync-progress-bar" style="height: 100%; width: 0%; background-color: var(--primary); border-radius: 3px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Data model
        let posts = JSON.parse(localStorage.getItem('linkedin_posts')) || [];

        // DOM Elements
        const sections = document.querySelectorAll('.section');
        const navItems = document.querySelectorAll('.nav-item');
        const postForm = document.getElementById('post-form');
        const editForm = document.getElementById('edit-form');
        const postStatusSelect = document.getElementById('post-status');
        const scheduledDateGroup = document.getElementById('scheduled-date-group');
        const editStatusSelect = document.getElementById('edit-post-status');
        const editScheduledDateGroup = document.getElementById('edit-scheduled-date-group');
        const cancelEditBtn = document.getElementById('cancel-edit');

        // LinkedIn account elements
        const connectLinkedInBtn = document.getElementById('connect-linkedin');
        const disconnectLinkedInBtn = document.getElementById('disconnect-linkedin');
        const syncLinkedInBtn = document.getElementById('sync-linkedin');
        const accountConnected = document.getElementById('account-connected');
        const accountDisconnected = document.getElementById('account-disconnected');
        const accountStatusIcon = document.getElementById('account-status-icon');
        const syncStatus = document.getElementById('sync-status');
        const syncProgress = document.getElementById('sync-progress');
        const syncProgressBar = document.getElementById('sync-progress-bar');
        const manualTokenInput = document.getElementById('manual-token');
        const saveTokenBtn = document.getElementById('save-token');

        // Navigation
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');

                const sectionId = item.dataset.section;
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
            });
        });

        // Show/hide scheduled date field based on status
        postStatusSelect.addEventListener('change', () => {
            scheduledDateGroup.style.display =
                postStatusSelect.value === 'scheduled' ? 'block' : 'none';

            if (postStatusSelect.value === 'scheduled') {
                // Set default scheduled date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0, 0, 0);

                document.getElementById('scheduled-date').value =
                    tomorrow.toISOString().slice(0, 16);
            }
        });

        editStatusSelect.addEventListener('change', () => {
            editScheduledDateGroup.style.display =
                editStatusSelect.value === 'scheduled' ? 'block' : 'none';
        });

        // LinkedIn Authentication UI Update
        function updateLinkedInUI() {
            // Check if user is authenticated with LinkedIn
            if (auth && auth.isAuthenticated()) {
                // Update the account status indicator
                accountStatusIcon.textContent = '🟢';
                // Show connected view
                accountConnected.style.display = 'block';
                accountDisconnected.style.display = 'none';
            } else {
                // Update the account status indicator
                accountStatusIcon.textContent = '🔴';
                // Show disconnected view
                accountConnected.style.display = 'none';
                accountDisconnected.style.display = 'block';
            }
        }

        // Connect LinkedIn Account
        if (connectLinkedInBtn) {
            connectLinkedInBtn.addEventListener('click', () => {
                if (auth) {
                    auth.login();
                }
            });
        }

        // Disconnect LinkedIn Account
        if (disconnectLinkedInBtn) {
            disconnectLinkedInBtn.addEventListener('click', () => {
                if (auth) {
                    if (confirm('Are you sure you want to disconnect your LinkedIn account?')) {
                        auth.logout();
                    }
                }
            });
        }

        // Save manual access token
        if (saveTokenBtn && manualTokenInput) {
            saveTokenBtn.addEventListener('click', () => {
                const token = manualTokenInput.value.trim();
                if (!token) {
                    alert('Please enter a valid access token');
                    return;
                }

                if (auth) {
                    const success = auth.setManualAccessToken(token);
                    if (success) {
                        alert('Access token saved successfully!');
                        manualTokenInput.value = '';
                    }
                }
            });
        }

        // Sync Posts from LinkedIn
        if (syncLinkedInBtn) {
            syncLinkedInBtn.addEventListener('click', async () => {
                if (!api || !auth.isAuthenticated()) return;

                try {
                    // Show sync status
                    syncStatus.style.display = 'block';
                    syncProgress.textContent = '0%';
                    syncProgressBar.style.width = '0%';

                    // Simulate progress updates
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += 5;
                        if (progress <= 90) {
                            syncProgress.textContent = `${progress}%`;
                            syncProgressBar.style.width = `${progress}%`;
                        }
                    }, 200);

                    // Get posts from LinkedIn API
                    const linkedInPosts = await api.getPosts();

                    // Get scheduled posts from LinkedIn API
                    const scheduledPosts = await api.getScheduledPosts();

                    // Combine all posts
                    const allLinkedInPosts = [...linkedInPosts, ...scheduledPosts];

                    // Add LinkedIn posts to the top of existing posts
                    // (avoiding duplicates based on LinkedIn ID)
                    const existingLinkedInIds = posts
                        .filter(post => post.id && post.id.startsWith('linkedin_'))
                        .map(post => post.id);

                    const newPosts = allLinkedInPosts.filter(post =>
                        !existingLinkedInIds.includes(post.id)
                    );

                    posts = [...newPosts, ...posts];
                    savePosts();

                    // Complete the progress indicator
                    clearInterval(progressInterval);
                    syncProgress.textContent = '100%';
                    syncProgressBar.style.width = '100%';

                    // Hide sync status after a short delay
                    setTimeout(() => {
                        syncStatus.style.display = 'none';
                        updateUI();
                    }, 1000);

                } catch (error) {
                    console.error('Error syncing posts:', error);
                    alert('Failed to sync posts from LinkedIn');
                    syncStatus.style.display = 'none';
                }
            });
        }

        // Save post
        postForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const status = postStatusSelect.value;

            let scheduledDate = null;
            if (status === 'scheduled') {
                scheduledDate = document.getElementById('scheduled-date').value;
                if (!scheduledDate) {
                    alert('Please select a scheduled date');
                    return;
                }
            }

            const likes = parseInt(document.getElementById('likes').value) || 0;
            const comments = parseInt(document.getElementById('comments').value) || 0;
            const shares = parseInt(document.getElementById('shares').value) || 0;

            const newPost = {
                id: Date.now(),
                title,
                content,
                status,
                createdAt: new Date().toISOString(),
                scheduledDate,
                engagement: {
                    likes,
                    comments,
                    shares
                }
            };

            posts.unshift(newPost);
            savePosts();
            postForm.reset();

            // Switch to the appropriate section based on post status
            if (status === 'scheduled') {
                document.querySelector('[data-section="scheduled"]').click();
            } else {
                document.querySelector('[data-section="posts"]').click();
            }

            updateUI();
        });

        // Edit post
        editForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const id = parseInt(document.getElementById('edit-post-id').value);
            const postIndex = posts.findIndex(post => post.id === id);

            if (postIndex === -1) return;

            const title = document.getElementById('edit-post-title').value;
            const content = document.getElementById('edit-post-content').value;
            const status = editStatusSelect.value;

            let scheduledDate = null;
            if (status === 'scheduled') {
                scheduledDate = document.getElementById('edit-scheduled-date').value;
                if (!scheduledDate) {
                    alert('Please select a scheduled date');
                    return;
                }
            }

            const likes = parseInt(document.getElementById('edit-likes').value) || 0;
            const comments = parseInt(document.getElementById('edit-comments').value) || 0;
            const shares = parseInt(document.getElementById('edit-shares').value) || 0;

            posts[postIndex] = {
                ...posts[postIndex],
                title,
                content,
                status,
                scheduledDate,
                updatedAt: new Date().toISOString(),
                engagement: {
                    likes,
                    comments,
                    shares
                }
            };

            savePosts();

            // Go back to previous section
            cancelEditBtn.click();

            updateUI();
        });

        // Cancel edit
        cancelEditBtn.addEventListener('click', () => {
            document.querySelector('[data-section="posts"]').click();
        });

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Calculate total engagement
        function calculateEngagement(post) {
            return post.engagement.likes + post.engagement.comments + post.engagement.shares;
        }

        // Edit post handler
        function editPost(id) {
            const post = posts.find(post => post.id === id);
            if (!post) return;

            document.getElementById('edit-post-id').value = post.id;
            document.getElementById('edit-post-title').value = post.title;
            document.getElementById('edit-post-content').value = post.content;
            document.getElementById('edit-post-status').value = post.status;

            if (post.status === 'scheduled') {
                editScheduledDateGroup.style.display = 'block';
                document.getElementById('edit-scheduled-date').value = post.scheduledDate;
            } else {
                editScheduledDateGroup.style.display = 'none';
            }

            document.getElementById('edit-likes').value = post.engagement.likes;
            document.getElementById('edit-comments').value = post.engagement.comments;
            document.getElementById('edit-shares').value = post.engagement.shares;

            // Switch to edit section
            sections.forEach(section => section.classList.remove('active'));
            document.getElementById('edit').classList.add('active');
            navItems.forEach(nav => nav.classList.remove('active'));
        }

        // Delete post handler
        function deletePost(id) {
            if (confirm('Are you sure you want to delete this post?')) {
                posts = posts.filter(post => post.id !== id);
                savePosts();
                updateUI();
            }
        }

        // Save posts to localStorage
        function savePosts() {
            localStorage.setItem('linkedin_posts', JSON.stringify(posts));
        }

        // Update UI with current data
        function updateUI() {
            updateDashboard();
            updatePostsTable();
            updateScheduledTable();
        }

        function updateDashboard() {
            // Update stats
            const totalPosts = posts.length;
            const publishedPosts = posts.filter(post => post.status === 'published').length;
            const scheduledPosts = posts.filter(post => post.status === 'scheduled').length;

            document.getElementById('total-posts').textContent = totalPosts;
            document.getElementById('published-posts').textContent = publishedPosts;
            document.getElementById('scheduled-posts').textContent = scheduledPosts;

            // Calculate average engagement
            const publishedPostsList = posts.filter(post => post.status === 'published');
            let avgEngagement = 0;

            if (publishedPostsList.length > 0) {
                const totalEngagement = publishedPostsList.reduce((sum, post) => {
                    return sum + calculateEngagement(post);
                }, 0);
                avgEngagement = Math.round(totalEngagement / publishedPostsList.length);
            }

            document.getElementById('avg-engagement').textContent = avgEngagement;

            // Recent posts table
            const recentPostsTable = document.getElementById('recent-posts-body');
            const noRecentPosts = document.getElementById('no-recent-posts');

            recentPostsTable.innerHTML = '';

            if (posts.length === 0) {
                noRecentPosts.style.display = 'block';
            } else {
                noRecentPosts.style.display = 'none';

                // Sort posts by created date (newest first) and take 5
                const recentPosts = [...posts]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 5);

                recentPosts.forEach(post => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${post.title}</td>
                        <td>${formatDate(post.status === 'scheduled' ? post.scheduledDate : post.createdAt)}</td>
                        <td>${calculateEngagement(post)}</td>
                        <td><span class="status-badge status-${post.status}">${post.status}</span></td>
                    `;

                    recentPostsTable.appendChild(row);
                });
            }
        }

        function updatePostsTable() {
            const allPostsTable = document.getElementById('all-posts-body');
            const noPosts = document.getElementById('no-posts');

            allPostsTable.innerHTML = '';

            if (posts.length === 0) {
                noPosts.style.display = 'block';
            } else {
                noPosts.style.display = 'none';

                posts.forEach(post => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${post.title}</td>
                        <td>${formatDate(post.status === 'scheduled' ? post.scheduledDate : post.createdAt)}</td>
                        <td>${calculateEngagement(post)}</td>
                        <td><span class="status-badge status-${post.status}">${post.status}</span></td>
                        <td class="post-actions">
                            <button class="btn btn-sm btn-secondary edit-post" data-id="${post.id}">Edit</button>
                            <button class="btn btn-sm btn-danger delete-post" data-id="${post.id}">Delete</button>
                        </td>
                    `;

                    allPostsTable.appendChild(row);
                });

                // Add event listeners to buttons
                document.querySelectorAll('.edit-post').forEach(btn => {
                    btn.addEventListener('click', () => {
                        editPost(parseInt(btn.dataset.id));
                    });
                });

                document.querySelectorAll('.delete-post').forEach(btn => {
                    btn.addEventListener('click', () => {
                        deletePost(parseInt(btn.dataset.id));
                    });
                });
            }
        }

        function updateScheduledTable() {
            const scheduledPostsTable = document.getElementById('scheduled-posts-body');
            const noScheduledPosts = document.getElementById('no-scheduled-posts');

            scheduledPostsTable.innerHTML = '';

            const scheduledPostsList = posts.filter(post => post.status === 'scheduled');

            if (scheduledPostsList.length === 0) {
                noScheduledPosts.style.display = 'block';
            } else {
                noScheduledPosts.style.display = 'none';

                // Sort by scheduled date (soonest first)
                scheduledPostsList
                    .sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate))
                    .forEach(post => {
                        const row = document.createElement('tr');

                        row.innerHTML = `
                            <td>${post.title}</td>
                            <td>${formatDate(post.scheduledDate)}</td>
                            <td class="post-actions">
                                <button class="btn btn-sm btn-secondary edit-post" data-id="${post.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-post" data-id="${post.id}">Delete</button>
                            </td>
                        `;

                        scheduledPostsTable.appendChild(row);
                    });

                // Add event listeners to buttons
                document.querySelectorAll('.edit-post').forEach(btn => {
                    btn.addEventListener('click', () => {
                        editPost(parseInt(btn.dataset.id));
                    });
                });

                document.querySelectorAll('.delete-post').forEach(btn => {
                    btn.addEventListener('click', () => {
                        deletePost(parseInt(btn.dataset.id));
                    });
                });
            }
        }

        // Initialize UI
        updateUI();

        // Initialize LinkedIn UI when auth is loaded
        if (typeof updateLinkedInUI === 'function') {
            document.addEventListener('DOMContentLoaded', () => {
                // Wait for auth to be initialized
                const authCheckInterval = setInterval(() => {
                    if (window.auth) {
                        updateLinkedInUI();
                        clearInterval(authCheckInterval);
                    }
                }, 100);
            });
        }
    </script>
</body>
</html>
